# Copyright Jerily LTD. All Rights Reserved.
# SPDX-FileCopyrightText: 2024 Neofytos Dimitriou (neo@jerily.cy)
# SPDX-License-Identifier: MIT.

if {[lsearch [namespace children] ::tcltest] == -1} {
    package require tcltest
    namespace import ::tcltest::*
}

package require tconfig

test tconfigDeploy-1.1 "Wrong args, no arguments" -setup {
    # make sure that $::argv is empty
    set ::_argv $::argv
    set ::argv {}
} -body {
    ::tconfig::deploy
} -cleanup {
    set ::argv $::_argv
    unset ::_argv
} -returnCodes error -result {required parameter path_to_config_file is not specified. should be "tconfig::deploy ?-app application_id? ?-aws_profile profile? -aws_kms_key key_id -environment environment path_to_config_file"}

test tconfigDeploy-1.2 "Wrong args, unknown arg" -body {
    ::tconfig::deploy -unknown
} -returnCodes error -result {Unknown option "-unknown". Supported options are -environment, -aws_kms_key, -aws_profile or -application}

test tconfigDeploy-1.3 "Wrong args, no -aws_kms_key" -body {
    ::tconfig::deploy -environment dev /fake/path
} -returnCodes error -result {required option -aws_kms_key is not specified. should be "tconfig::deploy ?-app application_id? ?-aws_profile profile? -aws_kms_key key_id -environment environment path_to_config_file"}

test tconfigDeploy-1.4 "Wrong args, no -environment" -body {
    ::tconfig::deploy -aws_kms_key key /fake/path
} -returnCodes error -result {required option -environment is not specified. should be "tconfig::deploy ?-app application_id? ?-aws_profile profile? -aws_kms_key key_id -environment environment path_to_config_file"}

test tconfigDeploy-1.5 "Wrong args, no config file" -body {
    ::tconfig::deploy -aws_kms_key key -environment dev
} -returnCodes error -result {required parameter path_to_config_file is not specified. should be "tconfig::deploy ?-app application_id? ?-aws_profile profile? -aws_kms_key key_id -environment environment path_to_config_file"}

test tconfigDeploy-1.6 "Wrong args, extra args" -body {
    ::tconfig::deploy -aws_kms_key key -environment dev /fake/path a
} -returnCodes error -result {wrong # args: should be "tconfig::deploy ?-app application_id? ?-aws_profile profile? -aws_kms_key key_id -environment environment path_to_config_file"}


test tconfigDeploy-2.1 "Deploy dev env" -setup {
    aws_seed
    set file [makeFile $::default_config_file config]
} -body {
    ::tconfig::deploy -env dev -aws_kms_key $::kms_key $file
    viewFile $file
} -cleanup {
    removeFile $file
    unset -nocomplain file
} -match glob -result {\[tconfig\]
tink_keyset = *

# test comment

# ^ empty line
\[db\]
somekey = untoched
encrypt:password = *
plain:hostname = dev-hostname

\[email\]
encrypt:password = *}

test tconfigDeploy-2.2 "Deploy prod env" -setup {
    aws_seed
    set file [makeFile $::default_config_file config]
} -body {
    ::tconfig::deploy -env prod -aws_kms_key $::kms_key $file
    viewFile $file
} -cleanup {
    removeFile $file
    unset -nocomplain file
} -match glob -result {\[tconfig\]
tink_keyset = *

# test comment

# ^ empty line
\[db\]
somekey = untoched
encrypt:password = *
plain:hostname = prod-hostname

\[email\]
encrypt:password = *}

