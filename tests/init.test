# Copyright Jerily LTD. All Rights Reserved.
# SPDX-FileCopyrightText: 2024 Neofytos Dimitriou (neo@jerily.cy)
# SPDX-License-Identifier: MIT.

if {[lsearch [namespace children] ::tcltest] == -1} {
    package require tcltest
    namespace import ::tcltest::*
}

package require tconfig

test tconfigInit-2.1 "Init dev env" -setup {
    aws_seed
    set file [makeFile $::default_config_file config]
} -body {
    ::tconfig::deploy -env dev -aws_kms_key $::kms_key $file
    ::tconfig::init $file
    set result [list]
    foreach section [lsort [::tconfig::sections]] {
        foreach key [lsort [::tconfig::keys $section]] {
            lappend result "!$section!$key![::tconfig::get $section $key]!"
        }
    }
    join $result \n
} -cleanup {
    removeFile $file
    unset -nocomplain file section key result
} -result {!db!hostname!dev-hostname!
!db!password!dev-password!
!db!somekey!untoched!
!email!password!dev-email-password!}

test tconfigInit-2.2 "Init prod env" -setup {
    aws_seed
    set file [makeFile $::default_config_file config]
} -body {
    ::tconfig::deploy -env prod -aws_kms_key $::kms_key $file
    ::tconfig::init $file
    set result [list]
    foreach section [lsort [::tconfig::sections]] {
        foreach key [lsort [::tconfig::keys $section]] {
            lappend result "!$section!$key![::tconfig::get $section $key]!"
        }
    }
    join $result \n
} -cleanup {
    removeFile $file
    unset -nocomplain file section key result
} -result {!db!hostname!prod-hostname!
!db!password!prod-password!
!db!somekey!untoched!
!email!password!prod-email-password!}
